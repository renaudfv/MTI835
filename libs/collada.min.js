THREE.ColladaLoader=function(){function B(a,b,c,d){var f=0;if(document.implementation&&document.implementation.createDocument){var g=new XMLHttpRequest;g.onreadystatechange=function(){4===g.readyState?0===g.status||200===g.status?g.response?(e=b,C(g.response,void 0,a)):d?d({type:"error",url:a}):console.error("ColladaLoader: Empty or non-existing file ("+a+")"):d?d({type:"error",url:a}):console.error("ColladaLoader: Couldn't load \""+a+'" ('+g.status+")"):3===g.readyState&&c&&(0===f&&(f=g.getResponseHeader("Content-Length")),c({total:f,loaded:g.responseText.length}))},g.open("GET",a,!0),g.send(null)}else alert("Don't know how to parse XML!")}function C(f,v,w){if(a=(new DOMParser).parseFromString(f,"text/xml"),v=v||e,void 0!==w){var x=w.split("/");x.pop(),s=(x.length<1?".":x.join("/"))+"/"}E(),bb(),g=F("library_images image",da,"image"),k=F("library_materials material",xa,"material"),l=F("library_effects effect",Ca,"effect"),j=F("library_geometries geometry",na,"geometry"),m=F("library_cameras camera",Ia,"camera"),n=F("library_lights light",Ka,"light"),i=F("library_controllers controller",ea,"controller"),h=F("library_animations animation",Ea,"animation"),q=F("library_visual_scenes visual_scene",ha,"visual_scene"),r=F("library_kinematics_models kinematics_model",Ma,"kinematics_model"),t=[],u=[],c=G(),b=new THREE.Group;for(var z=0;z<c.nodes.length;z++)b.add(T(c.nodes[z]));b.scale.multiplyScalar(y),I(),d=H(),S();var A={scene:b,morphs:t,skins:u,animations:o,kinematics:p,dae:{images:g,materials:k,cameras:m,lights:n,effects:l,geometries:j,controllers:i,animations:h,visualScenes:q,visualScene:c,scene:c,kinematicsModels:r,kinematicsModel:d}};return v&&v(A),A}function D(a){w=a}function E(){var b=a.querySelectorAll("asset"),c=b[0];if(c&&c.childNodes)for(var d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"unit":var f=e.getAttribute("meter");f&&(y=parseFloat(f));break;case"up_axis":z=e.textContent.charAt(0)}}}function F(b,c,d){for(var e=a.querySelectorAll(b),f={},g=0,h=e.length,i=0;h>i;i++){var j=e[i],k=(new c).parse(j);k.id&&0!==k.id.length||(k.id=d+g++),f[k.id]=k}return f}function G(){var b=a.querySelectorAll("scene instance_visual_scene")[0];if(b){var c=b.getAttribute("url").replace(/^#/,"");return q[c.length>0?c:"visual_scene0"]}return null}function H(){var b=a.querySelectorAll("instance_kinematics_model")[0];if(b){var c=b.getAttribute("url").replace(/^#/,"");return r[c.length>0?c:"kinematics_model0"]}return null}function I(){o=[],J(b)}function J(a){var b=c.getChildById(a.colladaId,!0),d=null;if(b&&b.keys){d={fps:60,hierarchy:[{node:b,keys:b.keys,sids:b.sids}],node:a,name:"animation_"+a.name,length:0},o.push(d);for(var e=0,f=b.keys.length;f>e;e++)d.length=Math.max(d.length,b.keys[e].time)}else d={hierarchy:[{keys:[],sids:[]}]};for(var e=0,f=a.children.length;f>e;e++)for(var g=J(a.children[e]),h=0,i=g.hierarchy.length;i>h;h++)d.hierarchy.push({keys:[],sids:[]});return d}function K(){var d,a=1e6,b=-a,c=0;for(var e in h){var f=h[e];d=d||f.id;for(var g=0;g<f.sampler.length;g++){var i=f.sampler[g];i.create(),a=Math.min(a,i.startTime),b=Math.max(b,i.endTime),c=Math.max(c,i.input.length)}}return{start:a,end:b,frames:c,ID:d}}function L(a,b){var c=b instanceof ka?i[b.url]:b;if(!c||!c.morph)return void console.log("could not find morph controller!");for(var d=c.morph,e=0;e<d.targets.length;e++){var f=d.targets[e],g=j[f];if(g.mesh&&g.mesh.primitives&&g.mesh.primitives.length){var h=g.mesh.primitives[0].geometry;h.vertices.length===a.vertices.length&&a.morphTargets.push({name:"target_1",vertices:h.vertices})}}a.morphTargets.push({name:"target_Z",vertices:a.vertices})}function N(a,b,c,d){if(a.world=a.world||new THREE.Matrix4,a.localworld=a.localworld||new THREE.Matrix4,a.world.copy(a.matrix),a.localworld.copy(a.matrix),a.channels&&a.channels.length){var e=a.channels[0],f=e.sampler.output[c];f instanceof THREE.Matrix4&&(a.world.copy(f),a.localworld.copy(f),0===c&&a.matrix.copy(f))}d&&a.world.multiplyMatrices(d,a.world),b.push(a);for(var g=0;g<a.nodes.length;g++)N(a.nodes[g],b,c,a.world)}function O(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=-1;if("JOINT"==d.type){for(var f=0;f<b.joints.length;f++)if(d.sid===b.joints[f]){e=f;break}if(e>=0){var g=b.invBindMatrices[e];d.invBindMatrix=g,d.skinningMatrix=new THREE.Matrix4,d.skinningMatrix.multiplyMatrices(d.world,g),d.animatrix=new THREE.Matrix4,d.animatrix.copy(d.localworld),d.weights=[];for(var f=0;f<b.weights.length;f++)for(var h=0;h<b.weights[f].length;h++){var i=b.weights[f][h];i.joint===e&&d.weights.push(i)}}else console.warn("ColladaLoader: Could not find joint '"+d.sid+"'."),d.skinningMatrix=new THREE.Matrix4,d.weights=[]}}}function P(a){var b=[],c=function(a,b,d){var e={};e.name=b.sid,e.parent=a,e.matrix=b.matrix;var f=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];e.matrix.decompose(f[0],f[1],f[2]),e.pos=[f[0].x,f[0].y,f[0].z],e.scl=[f[2].x,f[2].y,f[2].z],e.rotq=[f[1].x,f[1].y,f[1].z,f[1].w],d.push(e);for(var g in b.nodes)c(b.sid,b.nodes[g],d)};return c(-1,a,b),b}function Q(a,b,c){var d=[];N(b,d,-1),O(d,c.skin);for(var e=new THREE.Vector3,f=[],g=0;g<a.vertices.length;g++)f.push(new THREE.Vector3);for(g=0;g<d.length;g++)if("JOINT"==d[g].type)for(var h=0;h<d[g].weights.length;h++){var i=d[g].weights[h],j=i.index,k=i.weight,l=a.vertices[j],m=f[j];e.x=l.x,e.y=l.y,e.z=l.z,e.applyMatrix4(d[g].skinningMatrix),m.x+=e.x*k,m.y+=e.y*k,m.z+=e.z*k}for(var g=0;g<a.vertices.length;g++)a.vertices[g]=f[g]}function R(a,b,d){var e=i[b.url];if(d=void 0!==d?d:40,!e||!e.skin)return void console.log("ColladaLoader: Could not find skin controller.");if(!b.skeleton||!b.skeleton.length)return void console.log("ColladaLoader: Could not find the skeleton for the skin. ");for(var f=K(),g=c.getChildById(b.skeleton[0],!0)||c.getChildBySid(b.skeleton[0],!0),h=P(g),j=e.skin.joints,k=[],l=0;l<j.length;l++)for(var m=0;m<h.length;m++)h[m].name===j[l]&&(k[l]=h[m]);for(var l=0;l<k.length;l++)for(var m=0;m<k.length;m++)k[l].parent===k[m].name&&(k[l].parent=m);var l,m,p;new THREE.Vector3;for(l=0;l<a.vertices.length;l++)a.vertices[l].applyMatrix4(e.skin.bindShapeMatrix);for(var t=[],u=[],v=e.skin.weights,l=0;l<v.length;l++){var w=new THREE.Vector4(v[l][0]?v[l][0].joint:0,v[l][1]?v[l][1].joint:0,v[l][2]?v[l][2].joint:0,v[l][3]?v[l][3].joint:0),p=new THREE.Vector4(v[l][0]?v[l][0].weight:0,v[l][1]?v[l][1].weight:0,v[l][2]?v[l][2].weight:0,v[l][3]?v[l][3].weight:0);t.push(w),u.push(p)}a.skinIndices=t,a.skinWeights=u,a.bones=k;for(var x={name:f.ID,fps:30,length:f.frames/30,hierarchy:[]},m=0;m<k.length;m++)x.hierarchy.push({parent:k[m].parent,name:k[m].name,keys:[]});for(console.log("ColladaLoader:",f.ID+" has "+k.length+" bones."),Q(a,g,e),d=0;d<f.frames;d++){var y=[];N(g,y,d),O(y,e.skin);for(var l=0;l<y.length;l++)for(var m=0;m<x.hierarchy.length;m++)if(x.hierarchy[m].name===y[l].sid){var A={};A.time=d/30,A.matrix=y[l].animatrix,0===d&&(y[l].matrix=A.matrix);var B=[new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3];A.matrix.decompose(B[0],B[1],B[2]),A.pos=[B[0].x,B[0].y,B[0].z],A.scl=[B[2].x,B[2].y,B[2].z],A.rot=B[1],x.hierarchy[m].keys.push(A)}a.animation=x}}function S(){if(d&&0===d.joints.length)return void(p=void 0);var e={},f=function(a,f){var g=f.getAttribute("id"),h=c.getChildById(g,!0),i=d.joints[a];b.traverse(function(b){b.colladaId==g&&(e[a]={node:b,transforms:h.transforms,joint:i,position:i.zeroPosition})})};p={joints:d&&d.joints,getJointValue:function(a){var b=e[a];return b?b.position:void console.log("getJointValue: joint "+a+" doesn't exist")},setJointValue:function(a,b){var c=e[a];if(c){var d=c.joint;if(b>d.limits.max||b<d.limits.min)console.log("setJointValue: joint "+a+" value "+b+" outside of limits (min: "+d.limits.min+", max: "+d.limits.max+")");else if(d["static"])console.log("setJointValue: joint "+a+" is static");else{var f=c.node,g=d.axis,i=c.transforms,j=new THREE.Matrix4;for(h=0;h<i.length;h++){var k=i[h];if(k.sid&&-1!==k.sid.indexOf("joint"+a))switch(d.type){case"revolute":j.multiply(l.makeRotationAxis(g,THREE.Math.degToRad(b)));break;case"prismatic":j.multiply(l.makeTranslation(g.x*b,g.y*b,g.z*b));break;default:console.warn("setJointValue: unknown joint type: "+d.type)}else{var l=new THREE.Matrix4;switch(k.type){case"matrix":j.multiply(k.obj);break;case"translate":j.multiply(l.makeTranslation(k.obj.x,k.obj.y,k.obj.z));break;case"rotate":j.multiply(l.makeRotationAxis(k.obj,k.angle))}}}var m=j.elements,n=Array.prototype.slice.call(m),o=[n[0],n[4],n[8],n[12],n[1],n[5],n[9],n[13],n[2],n[6],n[10],n[14],n[3],n[7],n[11],n[15]];f.matrix.set.apply(f.matrix,o),f.matrix.decompose(f.position,f.quaternion,f.scale)}}else console.log("setJointValue: joint "+a+" doesn't exist")}};var g=a.querySelector("scene instance_kinematics_scene");if(g)for(var h=0;h<g.childNodes.length;h++){var i=g.childNodes[h];if(1==i.nodeType)switch(i.nodeName){case"bind_joint_axis":var j=i.getAttribute("target").split("/").pop(),k=i.querySelector("axis param").textContent,l=parseInt(k.split("joint").pop().split(".")[0]),m=a.querySelector('[sid="'+j+'"]');if(m){var n=m.parentElement;f(l,n)}}}}function T(a,b){var e,f,g,h,c=new THREE.Object3D,d=!1;for(g=0;g<a.controllers.length;g++){var o=i[a.controllers[g].url];switch(o.type){case"skin":if(j[o.skin.source]){var p=new ma;p.url=o.skin.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p),d=!0,e=a.controllers[g]}else if(i[o.skin.source]){var q=i[o.skin.source];if(f=q,q.morph&&j[q.morph.source]){var p=new ma;p.url=q.morph.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p)}}break;case"morph":if(j[o.morph.source]){var p=new ma;p.url=o.morph.source,p.instance_material=a.controllers[g].instance_material,a.geometries.push(p),f=a.controllers[g]}console.log("ColladaLoader: Morph-controller partially supported.")}}var r={};for(g=0;g<a.geometries.length;g++){var B,s=a.geometries[g],v=s.instance_material,w=j[s.url],y={},z=[],A=0;if(w){if(!w.mesh||!w.mesh.primitives)continue;if(0===c.name.length&&(c.name=w.id),v)for(h=0;h<v.length;h++){var C=v[h],D=k[C.target],E=D.instance_effect.url,F=l[E].shader,G=F.material;if(w.doubleSided){if(!(C.symbol in r)){var H=G.clone();H.side=THREE.DoubleSide,r[C.symbol]=H}G=r[C.symbol]}G.opacity=G.opacity?G.opacity:1,y[C.symbol]=A,z.push(G),B=G,B.name=null===D.name||""===D.name?D.id:D.name,A++}var I,J=B||new THREE.MeshLambertMaterial({color:14540253,side:w.doubleSided?THREE.DoubleSide:THREE.FrontSide}),K=w.mesh.geometry3js;if(A>1)for(J=new THREE.MultiMaterial(z),h=0;h<K.faces.length;h++){var M=K.faces[h];M.materialIndex=y[M.daeMaterial]}void 0!==e?(R(K,e),K.morphTargets.length>0?(J.morphTargets=!0,J.skinning=!1):(J.morphTargets=!1,J.skinning=!0),I=new THREE.SkinnedMesh(K,J,!1),I.name="skin_"+u.length,u.push(I)):void 0!==f?(L(K,f),J.morphTargets=!0,I=new THREE.Mesh(K,J),I.name="morph_"+t.length,t.push(I)):I=K.isLineStrip===!0?new THREE.Line(K):new THREE.Mesh(K,J),c.add(I)}}for(g=0;g<a.cameras.length;g++){var N=a.cameras[g],O=m[N.url],P=new THREE.PerspectiveCamera(O.yfov,parseFloat(O.aspect_ratio),parseFloat(O.znear),parseFloat(O.zfar));c.add(P)}for(g=0;g<a.lights.length;g++){var Q=null,S=a.lights[g],U=n[S.url];if(U&&U.technique){var V=U.color.getHex(),W=U.intensity,X=U.distance,Y=U.falloff_angle;switch(U.technique){case"directional":Q=new THREE.DirectionalLight(V,W,X),Q.position.set(0,0,1);break;case"point":Q=new THREE.PointLight(V,W,X);break;case"spot":Q=new THREE.SpotLight(V,W,X,Y),Q.position.set(0,0,1);break;case"ambient":Q=new THREE.AmbientLight(V)}}Q&&c.add(Q)}if(c.name=a.name||a.id||"",c.colladaId=a.id||"",c.layer=a.layer||"",c.matrix=a.matrix,c.matrix.decompose(c.position,c.quaternion,c.scale),x.centerGeometry&&c.geometry){var Z=c.geometry.center();Z.multiply(c.scale),Z.applyQuaternion(c.quaternion),c.position.sub(Z)}for(g=0;g<a.nodes.length;g++)c.add(T(a.nodes[g],a));return c}function V(b){for(var c=a.querySelectorAll("library_nodes node"),d=0;d<c.length;d++){var e=c[d].attributes.getNamedItem("id");if(e&&e.value===b)return c[d]}return void 0}function W(a){var b=[],c=1e6,d=-1e6;for(var e in h)for(var f=h[e],g=0;g<f.channel.length;g++){var i=f.channel[g],j=f.sampler[g],e=i.target.split("/")[0];e==a.id&&(j.create(),i.sampler=j,c=Math.min(c,j.startTime),d=Math.max(d,j.endTime),b.push(i))}return b.length&&(a.startTime=c,a.endTime=d),b}function Z(a){if(a.channels&&a.channels.length){for(var b=[],c=[],d=0,e=a.channels.length;e>d;d++){var k,f=a.channels[d],g=f.fullSid,h=f.sampler,i=h.input,j=a.getTransformBySid(f.sid);if(f.arrIndices){k=[];for(var l=0,m=f.arrIndices.length;m>l;l++)k[l]=gb(f.arrIndices[l])}else k=hb(f.member);if(j){-1===c.indexOf(g)&&c.push(g);for(var l=0,m=i.length;m>l;l++){var n=i[l],o=h.getData(j.type,l,k),p=$(b,n);if(!p){p=new Ha(n);var q=_(b,n);b.splice(-1===q?b.length:q,0,p)}p.addTarget(g,j,k,o)}}else console.log('Could not find transform "'+f.sid+'" in node '+a.id)}for(var d=0;d<c.length;d++)for(var r=c[d],l=0;l<b.length;l++){var p=b[l];p.hasTarget(r)||aa(b,p,l,r)}a.keys=b,a.sids=c}}function $(a,b){for(var c=null,d=0,e=a.length;e>d&&null===c;d++){var f=a[d];if(f.time===b)c=f;else if(f.time>b)break}return c}function _(a,b){for(var c=-1,d=0,e=a.length;e>d&&-1===c;d++){var f=a[d];f.time>=b&&(c=d)}return c}function aa(a,b,c,d){var e=ca(a,d,c?c-1:0),f=ba(a,d,c+1);if(e&&f){var k,g=(b.time-e.time)/(f.time-e.time),h=e.getTarget(d),i=f.getTarget(d).data,j=h.data;if("matrix"===h.type)k=j;else if(j.length){k=[];for(var l=0;l<j.length;++l)k[l]=j[l]+(i[l]-j[l])*g}else k=j+(i-j)*g;b.addTarget(d,h.transform,h.member,k)}}function ba(a,b,c){for(;c<a.length;c++){var d=a[c];if(d.hasTarget(b))return d}return null}function ca(a,b,c){for(c=c>=0?c:c+a.length;c>=0;c--){var d=a[c];if(d.hasTarget(b))return d}return null}function da(){this.id="",this.init_from=""}function ea(){this.id="",this.name="",this.type="",this.skin=null,this.morph=null}function fa(){this.method=null,this.source=null,this.targets=null,this.weights=null}function ga(){this.source="",this.bindShapeMatrix=null,this.invBindMatrices=[],this.joints=[],this.weights=[]}function ha(){this.id="",this.name="",this.nodes=[],this.scene=new THREE.Group}function ia(){this.id="",this.name="",this.sid="",this.nodes=[],this.controllers=[],this.transforms=[],this.geometries=[],this.channels=[],this.matrix=new THREE.Matrix4}function ja(){this.sid="",this.type="",this.data=[],this.obj=null}function ka(){this.url="",this.skeleton=[],this.instance_material=[]}function la(){this.symbol="",this.target=""}function ma(){this.url="",this.instance_material=[]}function na(){this.id="",this.mesh=null}function oa(a){this.geometry=a.id,this.primitives=[],this.vertices=null,this.geometry3js=null}function pa(){this.material="",this.count=0,this.inputs=[],this.vcount=null,this.p=[],this.geometry=new THREE.Geometry}function qa(){pa.call(this),this.vcount=[]}function ra(){pa.call(this),this.vcount=1}function sa(){pa.call(this),this.vcount=3}function ta(){this.source="",this.count=0,this.stride=0,this.params=[]}function ua(){this.input={}}function va(){this.semantic="",this.offset=0,this.source="",this.set=0}function wa(a){this.id=a,this.type=null}function xa(){this.id="",this.name="",this.instance_effect=null}function ya(){this.color=new THREE.Color,this.color.setRGB(Math.random(),Math.random(),Math.random()),this.color.a=1,this.texture=null,this.texcoord=null,this.texOpts=null}function za(a,b){this.type=a,this.effect=b,this.material=null}function Aa(a){this.effect=a,this.init_from=null,this.format=null}function Ba(a){this.effect=a,this.source=null,this.wrap_s=null,this.wrap_t=null,this.minfilter=null,this.magfilter=null,this.mipfilter=null}function Ca(){this.id="",this.name="",this.shader=null,this.surface={},this.sampler={}}function Da(){this.url=""}function Ea(){this.id="",this.name="",this.source={},this.sampler=[],this.channel=[]}function Fa(a){this.animation=a,this.source="",this.target="",this.fullSid=null,this.sid=null,this.dotSyntax=null,this.arrSyntax=null,this.arrIndices=null,this.member=null}function Ga(a){this.id="",this.animation=a,this.inputs=[],this.input=null,this.output=null,this.strideOut=null,this.interpolation=null,this.startTime=null,this.endTime=null,this.duration=0}function Ha(a){this.targets=[],this.time=a}function Ia(){this.id="",this.name="",this.technique=""}function Ja(){this.url=""}function Ka(){this.id="",this.name="",this.technique=""}function La(){this.url=""}function Ma(){this.id="",this.name="",this.joints=[],this.links=[]}function Na(){this.sid="",this.name="",this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0}function Oa(){this.sid="",this.name="",this.transforms=[],this.attachments=[]}function Pa(){this.joint="",this.transforms=[],this.links=[]}function Qa(a){var b=a.getAttribute("id");return void 0!=f[b]?f[b]:(f[b]=new wa(b).parse(a),f[b])}function Sa(a){for(var b=Va(a),c=[],d=0,e=b.length;e>d;d++)c.push("true"===b[d]||"1"===b[d]?!0:!1);return c}function Ta(a){for(var b=Va(a),c=[],d=0,e=b.length;e>d;d++)c.push(parseFloat(b[d]));return c}function Ua(a){for(var b=Va(a),c=[],d=0,e=b.length;e>d;d++)c.push(parseInt(b[d],10));return c}function Va(a){return a.length>0?Wa(a).split(/\s+/):[]}function Wa(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")}function Ya(a,b,c){return a.hasAttribute(b)?parseInt(a.getAttribute(b),10):c}function _a(a,b){var c=new THREE.ImageLoader;c.load(b,function(b){a.image=b,a.needsUpdate=!0})}function ab(a,b){a.doubleSided=!1;var c=b.querySelectorAll("extra double_sided")[0];c&&c&&1===parseInt(c.textContent,10)&&(a.doubleSided=!0)}function bb(){if(x.convertUpAxis!==!0||z===x.upAxis)A=null;else switch(z){case"X":A="Y"===x.upAxis?"XtoY":"XtoZ";break;case"Y":A="X"===x.upAxis?"YtoX":"YtoZ";break;case"Z":A="X"===x.upAxis?"ZtoX":"ZtoY"}}function cb(a,b){if(x.convertUpAxis===!0&&z!==x.upAxis)switch(A){case"XtoY":var c=a[0];a[0]=b*a[1],a[1]=c;break;case"XtoZ":var c=a[2];a[2]=a[1],a[1]=a[0],a[0]=c;break;case"YtoX":var c=a[0];a[0]=a[1],a[1]=b*c;break;case"YtoZ":var c=a[1];a[1]=b*a[2],a[2]=c;break;case"ZtoX":var c=a[0];a[0]=a[1],a[1]=a[2],a[2]=c;break;case"ZtoY":var c=a[1];a[1]=a[2],a[2]=b*c}}function db(a,b){if(x.convertUpAxis!==!0||z===x.upAxis)return b;switch(a){case"X":b="XtoY"===A?-1*b:b;break;case"Y":b="YtoZ"===A||"YtoX"===A?-1*b:b;break;case"Z":b="ZtoY"===A?-1*b:b}return b}function eb(a,b){var c=[a[b],a[b+1],a[b+2]];return cb(c,-1),new THREE.Vector3(c[0],c[1],c[2])}function fb(a){if(x.convertUpAxis){var b=[a[0],a[4],a[8]];cb(b,-1),a[0]=b[0],a[4]=b[1],a[8]=b[2],b=[a[1],a[5],a[9]],cb(b,-1),a[1]=b[0],a[5]=b[1],a[9]=b[2],b=[a[2],a[6],a[10]],cb(b,-1),a[2]=b[0],a[6]=b[1],a[10]=b[2],b=[a[0],a[1],a[2]],cb(b,-1),a[0]=b[0],a[1]=b[1],a[2]=b[2],b=[a[4],a[5],a[6]],cb(b,-1),a[4]=b[0],a[5]=b[1],a[6]=b[2],b=[a[8],a[9],a[10]],cb(b,-1),a[8]=b[0],a[9]=b[1],a[10]=b[2],b=[a[3],a[7],a[11]],cb(b,-1),a[3]=b[0],a[7]=b[1],a[11]=b[2]}return(new THREE.Matrix4).set(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15])}function gb(a){if(a>-1&&3>a){var b=["X","Y","Z"],c={X:0,Y:1,Z:2};a=hb(b[a]),a=c[a]}return a}function hb(a){if(x.convertUpAxis)switch(a){case"X":switch(A){case"XtoY":case"XtoZ":case"YtoX":a="Y";break;case"ZtoX":a="Z"}break;case"Y":switch(A){case"XtoY":case"YtoX":case"ZtoX":a="X";break;case"XtoZ":case"YtoZ":case"ZtoY":a="Z"}break;case"Z":switch(A){case"XtoZ":a="X";break;case"YtoZ":case"ZtoX":case"ZtoY":a="Y"}}return a}var c,d,o,p,q,r,s,t,u,a=null,b=null,e=null,f={},g={},h={},i={},j={},k={},l={},m={},n={},w=THREE.SmoothShading,x={centerGeometry:!1,convertUpAxis:!1,subdivideFaces:!0,upAxis:"Y",defaultEnvMap:null},y=1,z="Y",A=null;return da.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];"init_from"===c.nodeName&&(this.init_from=c.textContent)}return this},ea.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.type="none";for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"skin":this.skin=(new ga).parse(c),this.type=c.nodeName;break;case"morph":this.morph=(new fa).parse(c),this.type=c.nodeName}}return this},fa.prototype.parse=function(a){var d,b={},c=[];for(this.method=a.getAttribute("method"),this.source=a.getAttribute("source").replace(/^#/,""),d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(1==e.nodeType)switch(e.nodeName){case"source":var f=(new wa).parse(e);b[f.id]=f;break;case"targets":c=this.parseInputs(e);break;default:console.log(e.nodeName)}}for(d=0;d<c.length;d++){var g=c[d],f=b[g.source];switch(g.semantic){case"MORPH_TARGET":this.targets=f.read();break;case"MORPH_WEIGHT":this.weights=f.read()}}return this},fa.prototype.parseInputs=function(a){for(var b=[],c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":b.push((new va).parse(d))}}return b},ga.prototype.parse=function(a){var c,d,b={};this.source=a.getAttribute("source").replace(/^#/,""),this.invBindMatrices=[],this.joints=[],this.weights=[];for(var e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];if(1==f.nodeType)switch(f.nodeName){case"bind_shape_matrix":var g=Ta(f.textContent);this.bindShapeMatrix=fb(g);break;case"source":var h=(new wa).parse(f);b[h.id]=h;break;case"joints":c=f;break;case"vertex_weights":d=f;break;default:console.log(f.nodeName)}}return this.parseJoints(c,b),this.parseWeights(d,b),this},ga.prototype.parseJoints=function(a,b){for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"input":var e=(new va).parse(d),f=b[e.source];"JOINT"===e.semantic?this.joints=f.read():"INV_BIND_MATRIX"===e.semantic&&(this.invBindMatrices=f.read())}}},ga.prototype.parseWeights=function(a,b){for(var c,d,e=[],f=0;f<a.childNodes.length;f++){var g=a.childNodes[f];if(1==g.nodeType)switch(g.nodeName){case"input":e.push((new va).parse(g));break;case"v":c=Ua(g.textContent);break;case"vcount":d=Ua(g.textContent)}}for(var h=0,f=0;f<d.length;f++){for(var i=d[f],j=[],k=0;i>k;k++){for(var l={},m=0;m<e.length;m++){var n=e[m],o=c[h+n.offset];switch(n.semantic){case"JOINT":l.joint=o;break;case"WEIGHT":l.weight=b[n.source].data[o]}}j.push(l),h+=e.length}for(var k=0;k<j.length;k++)j[k].index=f;this.weights.push(j)}},ha.prototype.getChildById=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},ha.prototype.getChildBySid=function(a,b){for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},ha.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.nodes=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"node":this.nodes.push((new ia).parse(c))}}return this},ia.prototype.getChannelForTransform=function(a){for(var b=0;b<this.channels.length;b++){var i,j,c=this.channels[b],d=c.target.split("/"),f=(d.shift(),d.shift()),g=f.indexOf(".")>=0,h=f.indexOf("(")>=0;if(g)d=f.split("."),f=d.shift(),j=d.shift();else if(h){i=f.split("("),f=i.shift();for(var k=0;k<i.length;k++)i[k]=parseInt(i[k].replace(/\)/,""))}if(f===a)return c.info={sid:f,dotSyntax:g,arrSyntax:h,arrIndices:i},c}return null},ia.prototype.getChildById=function(a,b){if(this.id===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildById(a,b);if(d)return d}return null},ia.prototype.getChildBySid=function(a,b){if(this.sid===a)return this;if(b)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c].getChildBySid(a,b);if(d)return d}return null},ia.prototype.getTransformBySid=function(a){for(var b=0;b<this.transforms.length;b++)if(this.transforms[b].sid===a)return this.transforms[b];return null},ia.prototype.parse=function(a){var b;this.id=a.getAttribute("id"),this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.type=a.getAttribute("type"),this.layer=a.getAttribute("layer"),this.type="JOINT"===this.type?this.type:"NODE",this.nodes=[],this.transforms=[],this.geometries=[],this.cameras=[],this.lights=[],this.controllers=[],this.matrix=new THREE.Matrix4;for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"node":this.nodes.push((new ia).parse(d));break;case"instance_camera":this.cameras.push((new Ja).parse(d));break;case"instance_controller":this.controllers.push((new ka).parse(d));break;case"instance_geometry":this.geometries.push((new ma).parse(d));break;case"instance_light":this.lights.push((new La).parse(d));break;case"instance_node":b=d.getAttribute("url").replace(/^#/,"");var e=V(b);e&&this.nodes.push((new ia).parse(e));break;case"rotate":case"translate":case"scale":case"matrix":case"lookat":case"skew":this.transforms.push((new ja).parse(d));break;case"extra":break;default:console.log(d.nodeName)}}return this.channels=W(this),Z(this),this.updateMatrix(),this},ia.prototype.updateMatrix=function(){this.matrix.identity();for(var a=0;a<this.transforms.length;a++)this.transforms[a].apply(this.matrix)},ja.prototype.parse=function(a){return this.sid=a.getAttribute("sid"),this.type=a.nodeName,this.data=Ta(a.textContent),this.convert(),this},ja.prototype.convert=function(){switch(this.type){case"matrix":this.obj=fb(this.data);break;case"rotate":this.angle=THREE.Math.degToRad(this.data[3]);case"translate":cb(this.data,-1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;case"scale":cb(this.data,1),this.obj=new THREE.Vector3(this.data[0],this.data[1],this.data[2]);break;default:console.log("Can not convert Transform of type "+this.type)}},ja.prototype.apply=function(){var a=new THREE.Matrix4;return function(b){switch(this.type){case"matrix":b.multiply(this.obj);break;case"translate":b.multiply(a.makeTranslation(this.obj.x,this.obj.y,this.obj.z));break;case"rotate":b.multiply(a.makeRotationAxis(this.obj,this.angle));break;case"scale":b.scale(this.obj)}}}(),ja.prototype.update=function(a,b){var c=["X","Y","Z","ANGLE"];switch(this.type){case"matrix":if(b)if(1===b.length)switch(b[0]){case 0:this.obj.n11=a[0],this.obj.n21=a[1],this.obj.n31=a[2],this.obj.n41=a[3];break;case 1:this.obj.n12=a[0],this.obj.n22=a[1],this.obj.n32=a[2],this.obj.n42=a[3];break;case 2:this.obj.n13=a[0],this.obj.n23=a[1],this.obj.n33=a[2],this.obj.n43=a[3];break;case 3:this.obj.n14=a[0],this.obj.n24=a[1],this.obj.n34=a[2],this.obj.n44=a[3]}else if(2===b.length){var d="n"+(b[0]+1)+(b[1]+1);this.obj[d]=a}else console.log("Incorrect addressing of matrix in transform.");else this.obj.copy(a);break;case"translate":case"scale":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2]}break;case"rotate":switch("[object Array]"===Object.prototype.toString.call(b)&&(b=c[b[0]]),b){case"X":this.obj.x=a;break;case"Y":this.obj.y=a;break;case"Z":this.obj.z=a;break;case"ANGLE":this.angle=THREE.Math.degToRad(a);break;default:this.obj.x=a[0],this.obj.y=a[1],this.obj.z=a[2],this.angle=THREE.Math.degToRad(a[3])}}},ka.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.skeleton=[],this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1===c.nodeType)switch(c.nodeName){case"skeleton":this.skeleton.push(c.textContent.replace(/^#/,""));break;case"bind_material":for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new la).parse(f))}break;case"extra":}}return this},la.prototype.parse=function(a){return this.symbol=a.getAttribute("symbol"),this.target=a.getAttribute("target").replace(/^#/,""),this},ma.prototype.parse=function(a){this.url=a.getAttribute("url").replace(/^#/,""),this.instance_material=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType&&"bind_material"===c.nodeName){for(var d=c.querySelectorAll("instance_material"),e=0;e<d.length;e++){var f=d[e];this.instance_material.push((new la).parse(f))}break}}return this},na.prototype.parse=function(a){this.id=a.getAttribute("id"),ab(this,a);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"mesh":this.mesh=new oa(this).parse(c);break;case"extra":}}return this},oa.prototype.parse=function(a){this.primitives=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"source":Qa(c);break;case"vertices":this.vertices=(new ua).parse(c);break;case"linestrips":this.primitives.push((new ra).parse(c));break;case"triangles":this.primitives.push((new sa).parse(c));break;case"polygons":this.primitives.push((new pa).parse(c));break;case"polylist":this.primitives.push((new qa).parse(c))}}if(this.geometry3js=new THREE.Geometry,null===this.vertices)return this;for(var d=f[this.vertices.input.POSITION.source].data,b=0;b<d.length;b+=3)this.geometry3js.vertices.push(eb(d,b).clone());for(var b=0;b<this.primitives.length;b++){var e=this.primitives[b];e.setVertices(this.vertices),this.handlePrimitive(e,this.geometry3js)}return this.geometry3js.calcNormals&&(this.geometry3js.computeVertexNormals(),delete this.geometry3js.calcNormals),this},oa.prototype.handlePrimitive=function(a,b){if(a instanceof ra)return void(b.isLineStrip=!0);var c,d,h,i,j,k,l,e=a.p,g=a.inputs,m=0,n=3,o=0,p=[];for(c=0;c<g.length;c++){h=g[c];var q=h.offset+1;switch(o=q>o?q:o,h.semantic){case"TEXCOORD":p.push(h.set)}}for(var r=0;r<e.length;++r)for(var s=e[r],t=0;t<s.length;){var u=[],v=[],w=null,y=[];for(n=a.vcount?a.vcount.length?a.vcount[m++]:a.vcount:s.length/o,c=0;n>c;c++)for(d=0;d<g.length;d++)switch(h=g[d],k=f[h.source],i=s[t+c*o+h.offset],l=k.accessor.params.length,j=i*l,h.semantic){case"VERTEX":u.push(i);break;case"NORMAL":v.push(eb(k.data,j));break;case"TEXCOORD":w=w||{},void 0===w[h.set]&&(w[h.set]=[]),w[h.set].push(new THREE.Vector2(k.data[j],k.data[j+1]));break;case"COLOR":y.push((new THREE.Color).setRGB(k.data[j],k.data[j+1],k.data[j+2]))}if(0===v.length)if(h=this.vertices.input.NORMAL){k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;A>z;z++)v.push(eb(k.data,u[z]*l))}else b.calcNormals=!0;if(!w&&(w={},h=this.vertices.input.TEXCOORD)){p.push(h.set),k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;A>z;z++)j=u[z]*l,void 0===w[h.set]&&(w[h.set]=[]),w[h.set].push(new THREE.Vector2(k.data[j],1-k.data[j+1]))}if(0===y.length&&(h=this.vertices.input.COLOR)){k=f[h.source],l=k.accessor.params.length;for(var z=0,A=u.length;A>z;z++)j=u[z]*l,y.push((new THREE.Color).setRGB(k.data[j],k.data[j+1],k.data[j+2]))}var D,E,B=null,C=[];if(3===n)C.push(new THREE.Face3(u[0],u[1],u[2],v,y.length?y:new THREE.Color));else if(4===n)C.push(new THREE.Face3(u[0],u[1],u[3],v.length?[v[0].clone(),v[1].clone(),v[3].clone()]:[],y.length?[y[0],y[1],y[3]]:new THREE.Color)),C.push(new THREE.Face3(u[1],u[2],u[3],v.length?[v[1].clone(),v[2].clone(),v[3].clone()]:[],y.length?[y[1],y[2],y[3]]:new THREE.Color));else if(n>4&&x.subdivideFaces){var F=y.length?y:new THREE.Color;for(d=1;n-1>d;)C.push(new THREE.Face3(u[0],u[d],u[d+1],v.length?[v[0].clone(),v[d++].clone(),v[d].clone()]:[],F))}if(C.length)for(var z=0,A=C.length;A>z;z++)for(B=C[z],B.daeMaterial=a.material,b.faces.push(B),d=0;d<p.length;d++)D=w[p[d]],E=n>4?[D[0],D[z+1],D[z+2]]:4===n?0===z?[D[0],D[1],D[3]]:[D[1].clone(),D[2],D[3].clone()]:[D[0],D[1],D[2]],void 0===b.faceVertexUvs[d]&&(b.faceVertexUvs[d]=[]),b.faceVertexUvs[d].push(E);else console.log("dropped face with vcount "+n+" for geometry with id: "+b.id);t+=o*n}},pa.prototype.setVertices=function(a){for(var b=0;b<this.inputs.length;b++)this.inputs[b].source===a.id&&(this.inputs[b].source=a.input.POSITION.source)},pa.prototype.parse=function(a){this.material=a.getAttribute("material"),this.count=Ya(a,"count",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"input":this.inputs.push((new va).parse(a.childNodes[b]));break;case"vcount":this.vcount=Ua(c.textContent);break;
case"p":this.p.push(Ua(c.textContent));break;case"ph":console.warn("polygon holes not yet supported!")}}return this},qa.prototype=Object.create(pa.prototype),qa.prototype.constructor=qa,ra.prototype=Object.create(pa.prototype),ra.prototype.constructor=ra,sa.prototype=Object.create(pa.prototype),sa.prototype.constructor=sa,ta.prototype.parse=function(a){this.params=[],this.source=a.getAttribute("source"),this.count=Ya(a,"count",0),this.stride=Ya(a,"stride",0);for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if("param"===c.nodeName){var d={};d.name=c.getAttribute("name"),d.type=c.getAttribute("type"),this.params.push(d)}}return this},ua.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++)if("input"===a.childNodes[b].nodeName){var c=(new va).parse(a.childNodes[b]);this.input[c.semantic]=c}return this},va.prototype.parse=function(a){return this.semantic=a.getAttribute("semantic"),this.source=a.getAttribute("source").replace(/^#/,""),this.set=Ya(a,"set",-1),this.offset=Ya(a,"offset",0),"TEXCOORD"===this.semantic&&this.set<0&&(this.set=0),this},wa.prototype.parse=function(a){this.id=a.getAttribute("id");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"bool_array":this.data=Sa(c.textContent),this.type=c.nodeName;break;case"float_array":this.data=Ta(c.textContent),this.type=c.nodeName;break;case"int_array":this.data=Ua(c.textContent),this.type=c.nodeName;break;case"IDREF_array":case"Name_array":this.data=Va(c.textContent),this.type=c.nodeName;break;case"technique_common":for(var d=0;d<c.childNodes.length;d++)if("accessor"===c.childNodes[d].nodeName){this.accessor=(new ta).parse(c.childNodes[d]);break}}}return this},wa.prototype.read=function(){var a=[],b=this.accessor.params[0];switch(b.type){case"IDREF":case"Name":case"name":case"float":return this.data;case"float4x4":for(var c=0;c<this.data.length;c+=16){var d=this.data.slice(c,c+16),e=fb(d);a.push(e)}break;default:console.log("ColladaLoader: Source: Read dont know how to read "+b.type+".")}return a},xa.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++)if("instance_effect"===a.childNodes[b].nodeName){this.instance_effect=(new Da).parse(a.childNodes[b]);break}return this},ya.prototype.isColor=function(){return null===this.texture},ya.prototype.isTexture=function(){return null!=this.texture},ya.prototype.parse=function(a){"transparent"===a.nodeName&&(this.opaque=a.getAttribute("opaque"));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"color":var d=Ta(c.textContent);this.color=new THREE.Color,this.color.setRGB(d[0],d[1],d[2]),this.color.a=d[3];break;case"texture":this.texture=c.getAttribute("texture"),this.texcoord=c.getAttribute("texcoord"),this.texOpts={offsetU:0,offsetV:0,repeatU:1,repeatV:1,wrapU:1,wrapV:1},this.parseTexture(c)}}return this},ya.prototype.parseTexture=function(a){if(!a.childNodes)return this;a.childNodes[1]&&"extra"===a.childNodes[1].nodeName&&(a=a.childNodes[1],a.childNodes[1]&&"technique"===a.childNodes[1].nodeName&&(a=a.childNodes[1]));for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"offsetU":case"offsetV":case"repeatU":case"repeatV":this.texOpts[c.nodeName]=parseFloat(c.textContent);break;case"wrapU":case"wrapV":"TRUE"===c.textContent.toUpperCase()?this.texOpts[c.nodeName]=1:this.texOpts[c.nodeName]=parseInt(c.textContent);break;default:this.texOpts[c.nodeName]=c.textContent}}return this},za.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"emission":case"diffuse":case"specular":case"transparent":this[c.nodeName]=(new ya).parse(c);break;case"bump":var d=c.getAttribute("bumptype");d?"heightfield"===d.toLowerCase()?this.bump=(new ya).parse(c):"normalmap"===d.toLowerCase()?this.normal=(new ya).parse(c):(console.error("Shader.prototype.parse: Invalid value for attribute 'bumptype' ("+d+") - valid bumptypes are 'HEIGHTFIELD' and 'NORMALMAP' - defaulting to 'HEIGHTFIELD'"),this.bump=(new ya).parse(c)):(console.warn("Shader.prototype.parse: Attribute 'bumptype' missing from bump node - defaulting to 'HEIGHTFIELD'"),this.bump=(new ya).parse(c));break;case"shininess":case"reflectivity":case"index_of_refraction":case"transparency":var e=c.querySelectorAll("float");e.length>0&&(this[c.nodeName]=parseFloat(e[0].textContent))}}return this.create(),this},za.prototype.create=function(){var a={},b=!1;if(void 0!==this.transparency&&void 0!==this.transparent){var d=(this.transparent,(this.transparent.color.r+this.transparent.color.g+this.transparent.color.b)/3*this.transparency);d>0&&(b=!0,a.transparent=!0,a.opacity=1-d)}var e={diffuse:"map",ambient:"lightMap",specular:"specularMap",emission:"emissionMap",bump:"bumpMap",normal:"normalMap"};for(var f in this)switch(f){case"ambient":case"emission":case"diffuse":case"specular":case"bump":case"normal":var h=this[f];if(h instanceof ya)if(h.isTexture()){var i=h.texture,j=this.effect.sampler[i];if(void 0!==j&&void 0!==j.source){var k=this.effect.surface[j.source];if(void 0!==k){var l=g[k.init_from];if(l){var n,m=s+l.init_from,o=THREE.Loader.Handlers.get(m);null!==o?n=o.load(m):(n=new THREE.Texture,_a(n,m)),n.wrapS=h.texOpts.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.wrapT=h.texOpts.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,n.offset.x=h.texOpts.offsetU,n.offset.y=h.texOpts.offsetV,n.repeat.x=h.texOpts.repeatU,n.repeat.y=h.texOpts.repeatV,a[e[f]]=n,"emission"===f&&(a.emissive=16777215)}}}}else"diffuse"!==f&&b||("emission"===f?a.emissive=h.color.getHex():a[f]=h.color.getHex());break;case"shininess":a[f]=this[f];break;case"reflectivity":a[f]=this[f],a[f]>0&&(a.envMap=x.defaultEnvMap),a.combine=THREE.MixOperation;break;case"index_of_refraction":a.refractionRatio=this[f],1!==this[f]&&(a.envMap=x.defaultEnvMap);break;case"transparency":}switch(a.shading=w,a.side=this.effect.doubleSided?THREE.DoubleSide:THREE.FrontSide,void 0!==a.diffuse&&(a.color=a.diffuse,delete a.diffuse),this.type){case"constant":void 0!=a.emissive&&(a.color=a.emissive),this.material=new THREE.MeshBasicMaterial(a);break;case"phong":case"blinn":this.material=new THREE.MeshPhongMaterial(a);break;case"lambert":default:this.material=new THREE.MeshLambertMaterial(a)}return this.material},Aa.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"init_from":this.init_from=c.textContent;break;case"format":this.format=c.textContent;break;default:console.log("unhandled Surface prop: "+c.nodeName)}}return this},Ba.prototype.parse=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"source":this.source=c.textContent;break;case"minfilter":this.minfilter=c.textContent;break;case"magfilter":this.magfilter=c.textContent;break;case"mipfilter":this.mipfilter=c.textContent;break;case"wrap_s":this.wrap_s=c.textContent;break;case"wrap_t":this.wrap_t=c.textContent;break;default:console.log("unhandled Sampler2D prop: "+c.nodeName)}}return this},Ca.prototype.create=function(){return null===this.shader?null:void 0},Ca.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),ab(this,a),this.shader=null;for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"profile_COMMON":this.parseTechnique(this.parseProfileCOMMON(c))}}return this},Ca.prototype.parseNewparam=function(a){for(var b=a.getAttribute("sid"),c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"surface":this.surface[b]=new Aa(this).parse(d);break;case"sampler2D":this.sampler[b]=new Ba(this).parse(d);break;case"extra":break;default:console.log(d.nodeName)}}},Ca.prototype.parseProfileCOMMON=function(a){for(var b,c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];if(1==d.nodeType)switch(d.nodeName){case"profile_COMMON":this.parseProfileCOMMON(d);break;case"technique":b=d;break;case"newparam":this.parseNewparam(d);break;case"image":var e=(new da).parse(d);g[e.id]=e;break;case"extra":break;default:console.log(d.nodeName)}}return b},Ca.prototype.parseTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"constant":case"lambert":case"blinn":case"phong":this.shader=new za(c.nodeName,this).parse(c);break;case"extra":this.parseExtra(c)}}},Ca.prototype.parseExtra=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique":this.parseExtraTechnique(c)}}},Ca.prototype.parseExtraTechnique=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"bump":this.shader.parse(a)}}},Da.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ea.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.source={};for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"animation":var d=(new Ea).parse(c);for(var e in d.source)this.source[e]=d.source[e];for(var f=0;f<d.channel.length;f++)this.channel.push(d.channel[f]),this.sampler.push(d.sampler[f]);break;case"source":var e=(new wa).parse(c);this.source[e.id]=e;break;case"sampler":this.sampler.push(new Ga(this).parse(c));break;case"channel":this.channel.push(new Fa(this).parse(c))}}return this},Fa.prototype.parse=function(a){this.source=a.getAttribute("source").replace(/^#/,""),this.target=a.getAttribute("target");var b=this.target.split("/"),d=(b.shift(),b.shift()),e=d.indexOf(".")>=0,f=d.indexOf("(")>=0;if(e)b=d.split("."),this.sid=b.shift(),this.member=b.shift();else if(f){var g=d.split("(");this.sid=g.shift();for(var h=0;h<g.length;h++)g[h]=parseInt(g[h].replace(/\)/,""));this.arrIndices=g}else this.sid=d;return this.fullSid=d,this.dotSyntax=e,this.arrSyntax=f,this},Ga.prototype.parse=function(a){this.id=a.getAttribute("id"),this.inputs=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"input":this.inputs.push((new va).parse(c))}}return this},Ga.prototype.create=function(){for(var a=0;a<this.inputs.length;a++){var b=this.inputs[a],c=this.animation.source[b.source];switch(b.semantic){case"INPUT":this.input=c.read();break;case"OUTPUT":this.output=c.read(),this.strideOut=c.accessor.stride;break;case"INTERPOLATION":this.interpolation=c.read();break;case"IN_TANGENT":break;case"OUT_TANGENT":break;default:console.log(b.semantic)}}if(this.startTime=0,this.endTime=0,this.duration=0,this.input.length){this.startTime=1e8,this.endTime=-1e8;for(var a=0;a<this.input.length;a++)this.startTime=Math.min(this.startTime,this.input[a]),this.endTime=Math.max(this.endTime,this.input[a]);this.duration=this.endTime-this.startTime}},Ga.prototype.getData=function(a,b,c){var d;if("matrix"===a&&16===this.strideOut)d=this.output[b];else if(this.strideOut>1){d=[],b*=this.strideOut;for(var e=0;e<this.strideOut;++e)d[e]=this.output[b+e];if(3===this.strideOut)switch(a){case"rotate":case"translate":cb(d,-1);break;case"scale":cb(d,1)}else 4===this.strideOut&&"matrix"===a&&cb(d,-1)}else d=this.output[b],c&&"translate"===a&&(d=db(c,d));return d},Ha.prototype.addTarget=function(a,b,c,d){this.targets.push({sid:a,member:c,transform:b,data:d})},Ha.prototype.apply=function(a){for(var b=0;b<this.targets.length;++b){var c=this.targets[b];a&&c.sid!==a||c.transform.update(c.data,c.member)}},Ha.prototype.getTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return this.targets[b];return null},Ha.prototype.hasTarget=function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b].sid===a)return!0;return!1},Ha.prototype.interpolate=function(a,b){for(var c=0,d=this.targets.length;d>c;c++){var g,e=this.targets[c],f=a.getTarget(e.sid);if("matrix"!==e.transform.type&&f){var h=(b-this.time)/(a.time-this.time),i=f.data,j=e.data;if(0>h&&(h=0),h>1&&(h=1),j.length){g=[];for(var k=0;k<j.length;++k)g[k]=j[k]+(i[k]-j[k])*h}else g=j+(i-j)*h}else g=e.data;e.transform.update(g,e.member)}},Ia.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"optics":this.parseOptics(c)}}return this},Ia.prototype.parseOptics=function(a){for(var b=0;b<a.childNodes.length;b++)if("technique_common"===a.childNodes[b].nodeName)for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++)if(this.technique=c.childNodes[d].nodeName,"perspective"===this.technique)for(var e=c.childNodes[d],f=0;f<e.childNodes.length;f++){var g=e.childNodes[f];switch(g.nodeName){case"yfov":this.yfov=g.textContent;break;case"xfov":this.xfov=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}else if("orthographic"===this.technique)for(var h=c.childNodes[d],f=0;f<h.childNodes.length;f++){var g=h.childNodes[f];switch(g.nodeName){case"xmag":this.xmag=g.textContent;break;case"ymag":this.ymag=g.textContent;break;case"znear":this.znear=g.textContent;break;case"zfar":this.zfar=g.textContent;break;case"aspect_ratio":this.aspect_ratio=g.textContent}}return this},Ja.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ka.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c);break;case"technique":this.parseTechnique(c)}}return this},Ka.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++)switch(a.childNodes[b].nodeName){case"directional":case"point":case"spot":case"ambient":this.technique=a.childNodes[b].nodeName;for(var c=a.childNodes[b],d=0;d<c.childNodes.length;d++){var e=c.childNodes[d];switch(e.nodeName){case"color":var f=Ta(e.textContent);this.color=new THREE.Color(0),this.color.setRGB(f[0],f[1],f[2]),this.color.a=f[3];break;case"falloff_angle":this.falloff_angle=parseFloat(e.textContent);break;case"quadratic_attenuation":var g=parseFloat(e.textContent);this.distance=g?Math.sqrt(1/g):0}}}return this},Ka.prototype.parseTechnique=function(a){this.profile=a.getAttribute("profile");for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];switch(c.nodeName){case"intensity":this.intensity=parseFloat(c.textContent)}}return this},La.prototype.parse=function(a){return this.url=a.getAttribute("url").replace(/^#/,""),this},Ma.prototype.parse=function(a){this.id=a.getAttribute("id"),this.name=a.getAttribute("name"),this.joints=[],this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"technique_common":this.parseCommon(c)}}return this},Ma.prototype.parseCommon=function(a){for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(a.childNodes[b].nodeName){case"joint":this.joints.push((new Na).parse(c));break;case"link":this.links.push((new Oa).parse(c))}}return this},Na.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.axis=new THREE.Vector3,this.limits={min:0,max:0},this.type="",this["static"]=!1,this.zeroPosition=0,this.middlePosition=0;var b=a.querySelector("axis"),c=Ta(b.textContent);this.axis=eb(c,0);var d=a.querySelector("limits min")?parseFloat(a.querySelector("limits min").textContent):-360,e=a.querySelector("limits max")?parseFloat(a.querySelector("limits max").textContent):360;this.limits={min:d,max:e};for(var f=["prismatic","revolute"],g=0;g<f.length;g++){var h=f[g],i=a.querySelector(h);i&&(this.type=h)}return this.limits.min>=this.limits.max&&(this["static"]=!0),this.middlePosition=(this.limits.min+this.limits.max)/2,this},Oa.prototype.parse=function(a){this.sid=a.getAttribute("sid"),this.name=a.getAttribute("name"),this.transforms=[],this.attachments=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"attachment_full":this.attachments.push((new Pa).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ja).parse(c))}}return this},Pa.prototype.parse=function(a){this.joint=a.getAttribute("joint").split("/").pop(),this.links=[];for(var b=0;b<a.childNodes.length;b++){var c=a.childNodes[b];if(1==c.nodeType)switch(c.nodeName){case"link":this.links.push((new Oa).parse(c));break;case"rotate":case"translate":case"matrix":this.transforms.push((new ja).parse(c))}}return this},{load:B,parse:C,setPreferredShading:D,applySkin:R,geometries:j,options:x}};